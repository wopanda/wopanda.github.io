<!-- 自定义页脚扩展 -->

<!-- 统计代码（可选） -->
<!-- Google Analytics -->
{{ if hugo.IsProduction }}
{{ with .Site.Config.Services.GoogleAnalytics.ID }}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ . }}');
</script>
{{ end }}
{{ else }}
{{ with .Site.Params.googleAnalytics }}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ . }}');
</script>
{{ end }}
{{ end }}

<!-- 不蒜子统计 -->
<script>
// 设置不蒜子的独特站点标识
window.busuanzi_site_base64_decode = false;
window.busuanzi_site_offset = 0;
window.busuanzi_site_pv_header = "公考小饭团-PV";
window.busuanzi_site_uv_header = "公考小饭团-UV";
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- 百度统计（如果需要） -->
<!-- 
{{ if .Site.Params.baiduAnalytics }}
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?{{ .Site.Params.baiduAnalytics }}";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
{{ end }}
-->

<!-- 访问统计显示部件 -->
<div id="stats-widget" class="stats-widget">
  <div class="stats-container">
    <div class="stats-item">
      <span class="stats-icon">👥</span>
      <div class="stats-info">
        <div class="stats-number">
          <span id="busuanzi_value_site_pv" data-flag-title="公考小饭团博客">-</span>
        </div>
        <div class="stats-label">总访问量</div>
      </div>
    </div>
    <div class="stats-item">
      <span class="stats-icon">👤</span>
      <div class="stats-info">
        <div class="stats-number">
          <span id="busuanzi_value_site_uv" data-flag-title="公考小饭团博客">-</span>
        </div>
        <div class="stats-label">访客数</div>
      </div>
    </div>
    <div class="stats-item">
      <span class="stats-icon">📄</span>
      <div class="stats-info">
        <div class="stats-number">
          <span id="busuanzi_value_page_pv" data-flag-title="公考小饭团博客">-</span>
        </div>
        <div class="stats-label">本页访问</div>
      </div>
    </div>
  </div>
</div>

<!-- 回到顶部按钮 -->
<button id="back-to-top" title="回到顶部" style="display: none;">
  <span class="material-icons">keyboard_arrow_up</span>
</button>

<script>
// 回到顶部功能
const backToTopButton = document.getElementById('back-to-top');

window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTopButton.style.display = 'block';
  } else {
    backToTopButton.style.display = 'none';
  }
});

backToTopButton.addEventListener('click', () => {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
});

// 代码复制功能增强
document.addEventListener('DOMContentLoaded', function() {
  const codeBlocks = document.querySelectorAll('pre');
  
  codeBlocks.forEach(function(codeBlock) {
    const copyButton = document.createElement('button');
    copyButton.className = 'copy-code-button';
    copyButton.type = 'button';
    copyButton.innerText = '复制';
    
    copyButton.addEventListener('click', function() {
      const code = codeBlock.querySelector('code');
      const text = code.innerText;
      
      navigator.clipboard.writeText(text).then(function() {
        copyButton.innerText = '已复制!';
        setTimeout(function() {
          copyButton.innerText = '复制';
        }, 2000);
      });
    });
    
    codeBlock.appendChild(copyButton);
  });
});

// 图片懒加载
if ('IntersectionObserver' in window) {
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        imageObserver.unobserve(img);
      }
    });
  });

  document.querySelectorAll('img[data-src]').forEach(img => {
    imageObserver.observe(img);
  });
}

// 简化的右侧目录功能 - 固定定位 + 高亮跟随
document.addEventListener('DOMContentLoaded', function() {
  console.log('初始化简化版右侧目录...');
  
  const tocLinks = document.querySelectorAll('.toc-content a');
  const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
  
  if (tocLinks.length === 0 || headings.length === 0) {
    console.log('未找到目录或标题，跳过初始化');
    return;
  }
  
  console.log(`找到 ${tocLinks.length} 个目录链接和 ${headings.length} 个标题`);

  // 为每个标题添加ID（如果没有的话）
  headings.forEach((heading, index) => {
    if (!heading.id) {
      heading.id = 'heading-' + index;
    }
  });
  
  // 点击目录项平滑滚动
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        const headerHeight = 80;
        const targetPosition = targetElement.offsetTop - headerHeight;
        
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
      }
    });
  });
  
  // 简单的目录高亮功能
  function highlightCurrentSection() {
    let current = '';
    
    headings.forEach(heading => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 150) {
        current = heading.id;
      }
    });
    
    tocLinks.forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('href') === '#' + current) {
        link.classList.add('active');
      }
    });
  }
  
  // 点击目录项平滑滚动
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        const headerHeight = 80;
        const targetPosition = targetElement.offsetTop - headerHeight;
        
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
      }
    });
  });
  
  // 监听滚动事件，更新高亮
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        highlightCurrentSection();
        ticking = false;
      });
      ticking = true;
    }
  });
  
  // 初始化高亮
  highlightCurrentSection();
  
  console.log('简化版目录初始化完成');
});

// 移动端目录控制
document.addEventListener('DOMContentLoaded', function() {
  const tocSidebar = document.querySelector('.toc-sidebar');
  if (!tocSidebar) return;

  // 创建移动端目录按钮
  const mobileButton = document.createElement('div');
  mobileButton.className = 'mobile-toc-button';
  mobileButton.setAttribute('aria-label', '打开目录');
  document.body.appendChild(mobileButton);

  // 创建遮罩层
  const overlay = document.createElement('div');
  overlay.className = 'toc-overlay';
  document.body.appendChild(overlay);

  // 检查是否为移动端
  function isMobile() {
    return window.innerWidth <= 768;
  }

  // 切换移动端目录显示
  function toggleMobileToc() {
    const isOpen = tocSidebar.classList.contains('mobile-open');
    
    if (isOpen) {
      tocSidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
      mobileButton.classList.remove('active');
      document.body.style.overflow = '';
    } else {
      tocSidebar.classList.add('mobile-open');
      overlay.classList.add('active');
      mobileButton.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }

  // 关闭移动端目录
  function closeMobileToc() {
    tocSidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
    mobileButton.classList.remove('active');
    document.body.style.overflow = '';
  }

  // 事件监听
  mobileButton.addEventListener('click', toggleMobileToc);
  overlay.addEventListener('click', closeMobileToc);

  // 监听目录项点击，移动端点击后关闭目录
  document.addEventListener('click', function(e) {
    if (e.target.matches('.toc-content a') && isMobile()) {
      setTimeout(closeMobileToc, 200);
    }
  });

  // 监听窗口大小变化
  window.addEventListener('resize', function() {
    if (!isMobile()) {
      closeMobileToc();
      mobileButton.style.display = 'none';
    } else {
      mobileButton.style.display = 'flex';
    }
  });

  // 初始化移动端按钮状态
  if (isMobile()) {
    mobileButton.style.display = 'flex';
  } else {
    mobileButton.style.display = 'none';
  }
});

// 不蒜子统计增强功能
document.addEventListener('DOMContentLoaded', function() {
  const statsWidget = document.getElementById('stats-widget');
  if (!statsWidget) return;
  
  // 等待不蒜子加载完成后添加数字格式化
  function formatBusuanziNumbers() {
    const elements = [
      'busuanzi_value_site_pv',
      'busuanzi_value_site_uv', 
      'busuanzi_value_page_pv'
    ];
    
    elements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.textContent && element.textContent !== '-') {
        const num = parseInt(element.textContent);
        if (!isNaN(num)) {
          element.textContent = formatNumber(num);
        }
      }
    });
  }
  
  // 格式化数字显示
  function formatNumber(num) {
    if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'w';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
  }
  
  // 监听不蒜子数据加载
  let checkCount = 0;
  const checkInterval = setInterval(() => {
    checkCount++;
    const pvElement = document.getElementById('busuanzi_value_site_pv');
    
    if (pvElement && pvElement.textContent !== '-') {
      formatBusuanziNumbers();
      clearInterval(checkInterval);
      console.log('不蒜子统计加载完成');
    } else if (checkCount > 30) { // 15秒后停止检查
      clearInterval(checkInterval);
      console.log('不蒜子统计加载超时');
    }
  }, 500);
  
  // 页面可见性变化时重新检查数据
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(formatBusuanziNumbers, 1000);
    }
  });
  
  // 移动端收起/展开功能
  function addMobileToggle() {
    if (window.innerWidth <= 768) {
      let tapCount = 0;
      let tapTimer;
      
      statsWidget.addEventListener('click', function(e) {
        tapCount++;
        
        if (tapCount === 1) {
          tapTimer = setTimeout(() => {
            tapCount = 0;
          }, 300);
        } else if (tapCount === 2) {
          clearTimeout(tapTimer);
          tapCount = 0;
          
          // 双击切换收起/展开
          statsWidget.classList.toggle('collapsed');
        }
      });
    }
  }
  
  // 初始化移动端功能
  addMobileToggle();
  
  // 窗口大小变化时重新初始化
  window.addEventListener('resize', () => {
    if (window.innerWidth <= 768) {
      addMobileToggle();
    } else {
      statsWidget.classList.remove('collapsed');
    }
  });
  
  console.log('不蒜子统计部件初始化完成');
});
</script>

<style>
/* 回到顶部按钮样式 */
#back-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  box-shadow: var(--shadow-medium);
  transition: all 0.3s ease;
  z-index: 1000;
}

#back-to-top:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
}

/* 代码复制按钮样式 */
.copy-code-button {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.3s ease;
}

pre {
  position: relative;
}

pre:hover .copy-code-button {
  opacity: 1;
}

/* 图片懒加载样式 */
img.lazy {
  opacity: 0;
  transition: opacity 0.3s;
}

img.lazy.loaded {
  opacity: 1;
}

/* 访问统计部件样式 */
.stats-widget {
  position: fixed;
  bottom: 80px;
  right: 20px;
  z-index: 999;
  background: var(--theme);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow-medium);
  padding: 15px;
  font-size: 13px;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  max-width: 280px;
}

.stats-widget:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-large);
}

.stats-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stats-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--code-bg);
  border-radius: 8px;
  transition: background-color 0.2s ease;
}

.stats-item:hover {
  background: var(--tertiary);
}

.stats-icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.stats-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.stats-number {
  font-weight: 600;
  font-size: 16px;
  color: var(--accent);
  line-height: 1.2;
}

.stats-label {
  color: var(--secondary);
  font-size: 11px;
  line-height: 1.2;
  margin-top: 2px;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .stats-widget {
    bottom: 10px;
    right: 10px;
    left: auto;
    max-width: 120px;
    position: fixed;
    padding: 8px;
    opacity: 0.8;
    transform: scale(0.85);
  }
  
  .stats-container {
    flex-direction: column;
    gap: 6px;
  }
  
  .stats-item {
    flex: none;
    flex-direction: row;
    text-align: left;
    padding: 4px 6px;
    gap: 6px;
  }
  
  .stats-info {
    align-items: flex-start;
  }
  
  .stats-icon {
    font-size: 14px;
    width: 16px;
  }
  
  .stats-number {
    font-size: 11px;
    font-weight: 500;
  }
  
  .stats-label {
    font-size: 8px;
    margin-top: 1px;
  }
  
  /* 移动端添加收起/展开功能 */
  .stats-widget.collapsed {
    transform: scale(0.7);
    opacity: 0.6;
  }
  
  .stats-widget.collapsed .stats-container {
    display: none;
  }
  
  .stats-widget.collapsed::before {
    content: "📊";
    font-size: 16px;
    text-align: center;
    display: block;
  }
}

/* 隐藏状态 */
.stats-widget.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateY(20px);
}
</style>
