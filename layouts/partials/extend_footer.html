<!-- è‡ªå®šä¹‰é¡µè„šæ‰©å±• -->

<!-- ç»Ÿè®¡ä»£ç ï¼ˆå¯é€‰ï¼‰ -->
<!-- Google Analytics -->
{{ if hugo.IsProduction }}
{{ with .Site.Config.Services.GoogleAnalytics.ID }}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ . }}');
</script>
{{ end }}
{{ else }}
{{ with .Site.Params.googleAnalytics }}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ . }}');
</script>
{{ end }}
{{ end }}

<!-- ä¸è’œå­ç»Ÿè®¡ -->
<script>
// è®¾ç½®ä¸è’œå­çš„ç‹¬ç‰¹ç«™ç‚¹æ ‡è¯†
window.busuanzi_site_base64_decode = false;
window.busuanzi_site_offset = 0;
window.busuanzi_site_pv_header = "å…¬è€ƒå°é¥­å›¢-PV";
window.busuanzi_site_uv_header = "å…¬è€ƒå°é¥­å›¢-UV";
</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- ç™¾åº¦ç»Ÿè®¡ï¼ˆå¦‚æœéœ€è¦ï¼‰ -->
<!-- 
{{ if .Site.Params.baiduAnalytics }}
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?{{ .Site.Params.baiduAnalytics }}";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
{{ end }}
-->

<!-- è®¿é—®ç»Ÿè®¡æ˜¾ç¤ºéƒ¨ä»¶ -->
<div id="stats-widget" class="stats-widget">
  <div class="stats-container">
    <div class="stats-item">
      <span class="stats-icon">ğŸ‘¥</span>
      <div class="stats-info">
        <div class="stats-number">
          <span id="busuanzi_value_site_pv" data-flag-title="å…¬è€ƒå°é¥­å›¢åšå®¢">-</span>
        </div>
        <div class="stats-label">æ€»è®¿é—®é‡</div>
      </div>
    </div>
    <div class="stats-item">
      <span class="stats-icon">ğŸ‘¤</span>
      <div class="stats-info">
        <div class="stats-number">
          <span id="busuanzi_value_site_uv" data-flag-title="å…¬è€ƒå°é¥­å›¢åšå®¢">-</span>
        </div>
        <div class="stats-label">è®¿å®¢æ•°</div>
      </div>
    </div>
    <div class="stats-item">
      <span class="stats-icon">ğŸ“„</span>
      <div class="stats-info">
        <div class="stats-number">
          <span id="busuanzi_value_page_pv" data-flag-title="å…¬è€ƒå°é¥­å›¢åšå®¢">-</span>
        </div>
        <div class="stats-label">æœ¬é¡µè®¿é—®</div>
      </div>
    </div>
  </div>
</div>

<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<button id="back-to-top" title="å›åˆ°é¡¶éƒ¨" style="display: none;">
  <span class="material-icons">keyboard_arrow_up</span>
</button>

<script>
// å›åˆ°é¡¶éƒ¨åŠŸèƒ½
const backToTopButton = document.getElementById('back-to-top');

window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTopButton.style.display = 'block';
  } else {
    backToTopButton.style.display = 'none';
  }
});

backToTopButton.addEventListener('click', () => {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
});

// ä»£ç å¤åˆ¶åŠŸèƒ½å¢å¼º
document.addEventListener('DOMContentLoaded', function() {
  const codeBlocks = document.querySelectorAll('pre');
  
  codeBlocks.forEach(function(codeBlock) {
    const copyButton = document.createElement('button');
    copyButton.className = 'copy-code-button';
    copyButton.type = 'button';
    copyButton.innerText = 'å¤åˆ¶';
    
    copyButton.addEventListener('click', function() {
      const code = codeBlock.querySelector('code');
      const text = code.innerText;
      
      navigator.clipboard.writeText(text).then(function() {
        copyButton.innerText = 'å·²å¤åˆ¶!';
        setTimeout(function() {
          copyButton.innerText = 'å¤åˆ¶';
        }, 2000);
      });
    });
    
    codeBlock.appendChild(copyButton);
  });
});

// å›¾ç‰‡æ‡’åŠ è½½
if ('IntersectionObserver' in window) {
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        imageObserver.unobserve(img);
      }
    });
  });

  document.querySelectorAll('img[data-src]').forEach(img => {
    imageObserver.observe(img);
  });
}

// ç®€åŒ–çš„å³ä¾§ç›®å½•åŠŸèƒ½ - å›ºå®šå®šä½ + é«˜äº®è·Ÿéš
document.addEventListener('DOMContentLoaded', function() {
  console.log('åˆå§‹åŒ–ç®€åŒ–ç‰ˆå³ä¾§ç›®å½•...');
  
  const tocLinks = document.querySelectorAll('.toc-content a');
  const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
  
  if (tocLinks.length === 0 || headings.length === 0) {
    console.log('æœªæ‰¾åˆ°ç›®å½•æˆ–æ ‡é¢˜ï¼Œè·³è¿‡åˆå§‹åŒ–');
    return;
  }
  
  console.log(`æ‰¾åˆ° ${tocLinks.length} ä¸ªç›®å½•é“¾æ¥å’Œ ${headings.length} ä¸ªæ ‡é¢˜`);

  // ä¸ºæ¯ä¸ªæ ‡é¢˜æ·»åŠ IDï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
  headings.forEach((heading, index) => {
    if (!heading.id) {
      heading.id = 'heading-' + index;
    }
  });
  
  // ç‚¹å‡»ç›®å½•é¡¹å¹³æ»‘æ»šåŠ¨
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        const headerHeight = 80;
        const targetPosition = targetElement.offsetTop - headerHeight;
        
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
      }
    });
  });
  
  // ç®€å•çš„ç›®å½•é«˜äº®åŠŸèƒ½
  function highlightCurrentSection() {
    let current = '';
    
    headings.forEach(heading => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 150) {
        current = heading.id;
      }
    });
    
    tocLinks.forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('href') === '#' + current) {
        link.classList.add('active');
      }
    });
  }
  
  // ç‚¹å‡»ç›®å½•é¡¹å¹³æ»‘æ»šåŠ¨
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        const headerHeight = 80;
        const targetPosition = targetElement.offsetTop - headerHeight;
        
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
      }
    });
  });
  
  // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ›´æ–°é«˜äº®
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        highlightCurrentSection();
        ticking = false;
      });
      ticking = true;
    }
  });
  
  // åˆå§‹åŒ–é«˜äº®
  highlightCurrentSection();
  
  console.log('ç®€åŒ–ç‰ˆç›®å½•åˆå§‹åŒ–å®Œæˆ');
});

// ç§»åŠ¨ç«¯ç›®å½•æ§åˆ¶
document.addEventListener('DOMContentLoaded', function() {
  const tocSidebar = document.querySelector('.toc-sidebar');
  if (!tocSidebar) return;

  // åˆ›å»ºç§»åŠ¨ç«¯ç›®å½•æŒ‰é’®
  const mobileButton = document.createElement('div');
  mobileButton.className = 'mobile-toc-button';
  mobileButton.setAttribute('aria-label', 'æ‰“å¼€ç›®å½•');
  document.body.appendChild(mobileButton);

  // åˆ›å»ºé®ç½©å±‚
  const overlay = document.createElement('div');
  overlay.className = 'toc-overlay';
  document.body.appendChild(overlay);

  // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
  function isMobile() {
    return window.innerWidth <= 768;
  }

  // åˆ‡æ¢ç§»åŠ¨ç«¯ç›®å½•æ˜¾ç¤º
  function toggleMobileToc() {
    const isOpen = tocSidebar.classList.contains('mobile-open');
    
    if (isOpen) {
      tocSidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
      mobileButton.classList.remove('active');
      document.body.style.overflow = '';
    } else {
      tocSidebar.classList.add('mobile-open');
      overlay.classList.add('active');
      mobileButton.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }

  // å…³é—­ç§»åŠ¨ç«¯ç›®å½•
  function closeMobileToc() {
    tocSidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
    mobileButton.classList.remove('active');
    document.body.style.overflow = '';
  }

  // äº‹ä»¶ç›‘å¬
  mobileButton.addEventListener('click', toggleMobileToc);
  overlay.addEventListener('click', closeMobileToc);

  // ç›‘å¬ç›®å½•é¡¹ç‚¹å‡»ï¼Œç§»åŠ¨ç«¯ç‚¹å‡»åå…³é—­ç›®å½•
  document.addEventListener('click', function(e) {
    if (e.target.matches('.toc-content a') && isMobile()) {
      setTimeout(closeMobileToc, 200);
    }
  });

  // ç›‘å¬çª—å£å¤§å°å˜åŒ–
  window.addEventListener('resize', function() {
    if (!isMobile()) {
      closeMobileToc();
      mobileButton.style.display = 'none';
    } else {
      mobileButton.style.display = 'flex';
    }
  });

  // åˆå§‹åŒ–ç§»åŠ¨ç«¯æŒ‰é’®çŠ¶æ€
  if (isMobile()) {
    mobileButton.style.display = 'flex';
  } else {
    mobileButton.style.display = 'none';
  }
});

// ä¸è’œå­ç»Ÿè®¡å¢å¼ºåŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
  const statsWidget = document.getElementById('stats-widget');
  if (!statsWidget) return;
  
  // ç­‰å¾…ä¸è’œå­åŠ è½½å®Œæˆåæ·»åŠ æ•°å­—æ ¼å¼åŒ–
  function formatBusuanziNumbers() {
    const elements = [
      'busuanzi_value_site_pv',
      'busuanzi_value_site_uv', 
      'busuanzi_value_page_pv'
    ];
    
    elements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.textContent && element.textContent !== '-') {
        const num = parseInt(element.textContent);
        if (!isNaN(num)) {
          element.textContent = formatNumber(num);
        }
      }
    });
  }
  
  // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
  function formatNumber(num) {
    if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'w';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
  }
  
  // ç›‘å¬ä¸è’œå­æ•°æ®åŠ è½½
  let checkCount = 0;
  const checkInterval = setInterval(() => {
    checkCount++;
    const pvElement = document.getElementById('busuanzi_value_site_pv');
    
    if (pvElement && pvElement.textContent !== '-') {
      formatBusuanziNumbers();
      clearInterval(checkInterval);
      console.log('ä¸è’œå­ç»Ÿè®¡åŠ è½½å®Œæˆ');
    } else if (checkCount > 30) { // 15ç§’ååœæ­¢æ£€æŸ¥
      clearInterval(checkInterval);
      console.log('ä¸è’œå­ç»Ÿè®¡åŠ è½½è¶…æ—¶');
    }
  }, 500);
  
  // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥æ•°æ®
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(formatBusuanziNumbers, 1000);
    }
  });
  
  // ç§»åŠ¨ç«¯æ”¶èµ·/å±•å¼€åŠŸèƒ½
  function addMobileToggle() {
    if (window.innerWidth <= 768) {
      let tapCount = 0;
      let tapTimer;
      
      statsWidget.addEventListener('click', function(e) {
        tapCount++;
        
        if (tapCount === 1) {
          tapTimer = setTimeout(() => {
            tapCount = 0;
          }, 300);
        } else if (tapCount === 2) {
          clearTimeout(tapTimer);
          tapCount = 0;
          
          // åŒå‡»åˆ‡æ¢æ”¶èµ·/å±•å¼€
          statsWidget.classList.toggle('collapsed');
        }
      });
    }
  }
  
  // åˆå§‹åŒ–ç§»åŠ¨ç«¯åŠŸèƒ½
  addMobileToggle();
  
  // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–
  window.addEventListener('resize', () => {
    if (window.innerWidth <= 768) {
      addMobileToggle();
    } else {
      statsWidget.classList.remove('collapsed');
    }
  });
  
  console.log('ä¸è’œå­ç»Ÿè®¡éƒ¨ä»¶åˆå§‹åŒ–å®Œæˆ');
});
</script>

<style>
/* å›åˆ°é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
#back-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  box-shadow: var(--shadow-medium);
  transition: all 0.3s ease;
  z-index: 1000;
}

#back-to-top:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
}

/* ä»£ç å¤åˆ¶æŒ‰é’®æ ·å¼ */
.copy-code-button {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.3s ease;
}

pre {
  position: relative;
}

pre:hover .copy-code-button {
  opacity: 1;
}

/* å›¾ç‰‡æ‡’åŠ è½½æ ·å¼ */
img.lazy {
  opacity: 0;
  transition: opacity 0.3s;
}

img.lazy.loaded {
  opacity: 1;
}

/* è®¿é—®ç»Ÿè®¡éƒ¨ä»¶æ ·å¼ */
.stats-widget {
  position: fixed;
  bottom: 80px;
  right: 20px;
  z-index: 999;
  background: var(--theme);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow-medium);
  padding: 15px;
  font-size: 13px;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  max-width: 280px;
}

.stats-widget:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-large);
}

.stats-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stats-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--code-bg);
  border-radius: 8px;
  transition: background-color 0.2s ease;
}

.stats-item:hover {
  background: var(--tertiary);
}

.stats-icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.stats-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.stats-number {
  font-weight: 600;
  font-size: 16px;
  color: var(--accent);
  line-height: 1.2;
}

.stats-label {
  color: var(--secondary);
  font-size: 11px;
  line-height: 1.2;
  margin-top: 2px;
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
  .stats-widget {
    bottom: 10px;
    right: 10px;
    left: auto;
    max-width: 120px;
    position: fixed;
    padding: 8px;
    opacity: 0.8;
    transform: scale(0.85);
  }
  
  .stats-container {
    flex-direction: column;
    gap: 6px;
  }
  
  .stats-item {
    flex: none;
    flex-direction: row;
    text-align: left;
    padding: 4px 6px;
    gap: 6px;
  }
  
  .stats-info {
    align-items: flex-start;
  }
  
  .stats-icon {
    font-size: 14px;
    width: 16px;
  }
  
  .stats-number {
    font-size: 11px;
    font-weight: 500;
  }
  
  .stats-label {
    font-size: 8px;
    margin-top: 1px;
  }
  
  /* ç§»åŠ¨ç«¯æ·»åŠ æ”¶èµ·/å±•å¼€åŠŸèƒ½ */
  .stats-widget.collapsed {
    transform: scale(0.7);
    opacity: 0.6;
  }
  
  .stats-widget.collapsed .stats-container {
    display: none;
  }
  
  .stats-widget.collapsed::before {
    content: "ğŸ“Š";
    font-size: 16px;
    text-align: center;
    display: block;
  }
}

/* éšè—çŠ¶æ€ */
.stats-widget.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateY(20px);
}
</style>
